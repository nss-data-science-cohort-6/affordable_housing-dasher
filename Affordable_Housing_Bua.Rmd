---
title: "Assessing the Impact of Affordable Housing Development"
output: html_notebook
---


```{r}
library(readr)
library(readxl)
library(tidyverse)
```

```{r}
filtered_sales <- read_csv("filtered_sales.csv") 
assessments <- read_csv("assessments.csv")
LIHTC <- read_csv("LIHTC.csv")
property_details <- read_csv("property_details.csv")
barnes <- read_csv("barnes.csv")
X2021_Active_Property_List <- read_excel("2021_Active_Property_List.xlsx")

#filtered_sales, assessments, property_details can join on 'apn'
```

```{r}
#Data Manipulations in filtered_sales
filtered_sales$owneryear <- format(filtered_sales$ownerdate, format = "%Y")
filtered_sales$ownermonth <- format(filtered_sales$ownerdate, format = "%m")

assessments$effective_year <- format(assessments$effectivedate, format = "%Y")
assessments$effective_month <- format(assessments$effectivedate, format = "%m")

#Check duplicated rows 
nrow(filtered_sales[duplicated(filtered_sales),]) #7507
nrow(assessments[duplicated(assessments),]) #23160
nrow(property_details[duplicated(property_details),]) #2

#General Exploratory Analysis
length(unique(filtered_sales$apn)) #38.62762% of the data set are unique apn in filtered_sales

```

```{r}
#filtered_sales contains sales of single family homes from 1995 to the present day. It has been filtered to remove sales that are likely not arms-length transactions and transactions for parcels which did not have a house on them at the time of sale. This was done by removing any transations for $0, any transactions for which the adjacent appraisal values showed $0 for improvents, and any for which the transaction amount was less than half of the adjacent appraisals. 

filtered_sales %>%
  distinct() %>%
  group_by(owneryear) %>%
  summarize(sum_amount = sum(amount)) %>%
  ggplot(aes(x=owneryear, y=sum_amount))+
  geom_col()+
  ggtitle('Total Sales by Owner Year')+
  theme(axis.text.x = element_text(angle = 45, hjust=1))+
  xlab('Owner Year')+
  scale_y_continuous(name = 'Total Amount in USD (billions)', labels = unit_format(scale = 1e-9, unit = ''))

filtered_sales %>%
  distinct() %>%
  group_by(owneryear) %>%
  summarize(max_amount = max(amount)) %>%
  ggplot(aes(x=owneryear, y=max_amount))+
  geom_col(fill='red')+
  ggtitle('Max Sales by Owner Year')+
  theme(axis.text.x = element_text(angle = 45, hjust=1))+
  xlab('Owner Year')+
  scale_y_continuous(name = 'Max Sales USD (millions)', labels = unit_format(scale = 1e-6, unit = ''))

filtered_sales %>%
  distinct() %>%
  group_by(owneryear) %>%
  summarize(median_amount = median(amount)) %>%
  ggplot(aes(x=owneryear, y=median_amount))+
  geom_col(fill='blue')+
  ggtitle('Median Sales by Owner Year')+
  theme(axis.text.x = element_text(angle = 45, hjust=1))+
  xlab('Owner Year')+
  scale_y_continuous(name = 'Median Sales USD (millions)', labels = unit_format(scale = 1e-5, unit = ''))

filtered_sales %>%
  distinct() %>%
  group_by(owneryear) %>%
  summarize(count_apn = n_distinct(apn)) %>%
  ggplot(aes(x=owneryear, y=count_apn))+
  geom_col(fill='pink')+
  ggtitle('Historical Unique Property Count by Owner Year')+
  theme(axis.text.x = element_text(angle = 45, hjust=1))+
  xlab('Owner Year')+
  scale_y_continuous(name = 'Count of Unique Property (in 1000s)', labels = unit_format(scale = 1e-3, unit = ''))


```



```{r}
# 1. Using the sf library, find the closest development to each home. Hint: You can convert a tibble to an sf (simple feature) object using the [`st_as_sf` function](https://r-spatial.github.io/sf/reference/st_as_sf.html). See, for example, this stackoverflow post: https://gis.stackexchange.com/questions/222978/lon-lat-to-simple-features-sfg-and-sfc-in-r. Once converted, you can use the [`get_nearest_feature` function](https://r-spatial.github.io/sf/reference/st_nearest_feature.html).

library(stringr)
property_details[c('Longitude', 'Latitude')] <- str_split_fixed(property_details$centroid, ',', 2)
property_details$Longitude <- str_sub(property_details$Longitude, 2, -1)
property_details$Latitude <- str_sub(property_details$Latitude, 1, -2)

library(sf)

#Generate 'geometry' column in LIHTC and property_details
LIHTC <- st_as_sf(LIHTC, coords = c("LONGITUDE", "LATITUDE"), 
                 crs = 4326, agr = "constant")

property_details <- st_as_sf(property_details, coords = c("Longitude", "Latitude"), 
                 crs = 4326, agr = "constant")

#The following code returns: for each feature (geometry) in property_details the index of the nearest feature (geometry) in set LIHTC
try(st_nearest_feature(property_details, LIHTC))
#Add HUD_ID column to property_details
property_details$HUD_ID <- LIHTC$HUD_ID[st_nearest_feature(property_details, LIHTC)]

```


```{r}
#2. Calculate the distance from each home its closest development.
# test prop_distance <- st_distance(property_details[1:10,], LIHTC)

#lapply outputs a list, we add do.call('c' to output a vector
#prop_distances <- do.call('c',lapply(1:nrow(property_details),function(i){

#prop_distances <- do.call('c',lapply(1:100,function(i){
prop_distances <- do.call('c',lapply(1:nrow(property_details),function(i){
  #i=1 for testing
  print(paste(i,nrow(property_details),sep='/')) 
  curr.prop <- property_details[i,]
  curr.lihtc <- subset(LIHTC,HUD_ID==curr.prop$HUD_ID)
  curr.dist <- st_distance(curr.prop,curr.lihtc)
  return(as.numeric(curr.dist))
  }))

save(prop_distances,file='/Users/thidathornvanitsthian/Documents/Data Science 2022/affordable_housing-dasher/Data/prop_distances.Rdata')

#load('/Users/thidathornvanitsthian/Documents/Data Science 2022/affordable_housing-dasher/Data/prop_distances.Rdata')

library(maps)
#subset of lat long around Davidson County from map_data 
county.lines <- subset(map_data('county'),region=='tennessee' & subregion=='davidson') 

#NNDist: nearest neighbor distance
property_details$NNDist<-prop_distances
ggplot(property_details)+
  geom_sf(aes(colour=NNDist))+
  geom_sf(data = LIHTC, shape=23) +
  geom_path(data = county.lines, mapping=aes(x=long, y=lat, group=group)) +
  scale_colour_gradientn(colours=rainbow(100)[75:1]) 
  
# group=group name of a column in county.lines
# affordable housing developments (diamiond shapes) are right on the purple color
# ?pch
#this splits the rainbow into 100 colours, we only want 75 of the 100 rainbow colours but in reverse order [75:1]

#distances are small in the center 


```

```{r}
#3. Filter the homes down to those that are within one mile of an affordable housing development.
# 1 mile = 1609 m
property_within_1mile <- subset(property_details, NNDist<1609)

#69705 observations are within a mile of the nearest affordable housing developments
```


```{r}
#4. For each remaining home, calculate a new column called "group", which is defined according to the following rules. Hint: Use the `case_when` function to do this.  
#	* "pre" - for homes where the distance is less than half a mile and whose sale date was 2-5 years prior to the input year  
#	* "mid" - for homes where the distance is less than half a mile and whose sale date was 0-2 years prior to the input year  
#	* "post" - for homes where the distance is less than half a mile and whose sale date was after the input year  
#	* "outside" - for homes where the distance is more than half a mile and whose sale date was no more than 5 years prior to the input year  
#	* "other" - All other rows  
```



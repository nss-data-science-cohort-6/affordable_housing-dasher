---
title: "Assessing the Impact of Affordable Housing Development"
output: html_notebook
---


```{r}
library(readr)
library(readxl)
library(tidyverse)
```

```{r}
filtered_sales <- read_csv("filtered_sales.csv") 
assessments <- read_csv("assessments.csv")
LIHTC <- read_csv("LIHTC.csv")
property_details <- read_csv("property_details.csv")
barnes <- read_csv("barnes.csv")
X2021_Active_Property_List <- read_excel("2021_Active_Property_List.xlsx")

#filtered_sales, assessments, property_details can join on 'apn'
```

```{r}
#Data Manipulations in filtered_sales
filtered_sales$owneryear <- format(filtered_sales$ownerdate, format = "%Y")
filtered_sales$ownermonth <- format(filtered_sales$ownerdate, format = "%m")

assessments$effective_year <- format(assessments$effectivedate, format = "%Y")
assessments$effective_month <- format(assessments$effectivedate, format = "%m")

#Check duplicated rows 
nrow(filtered_sales[duplicated(filtered_sales),]) #7507
nrow(assessments[duplicated(assessments),]) #23160
nrow(property_details[duplicated(property_details),]) #2

#General Exploratory Analysis
length(unique(filtered_sales$apn)) #38.62762% of the data set are unique apn in filtered_sales

```

```{r}
#filtered_sales contains sales of single family homes from 1995 to the present day. It has been filtered to remove sales that are likely not arms-length transactions and transactions for parcels which did not have a house on them at the time of sale. This was done by removing any transations for $0, any transactions for which the adjacent appraisal values showed $0 for improvents, and any for which the transaction amount was less than half of the adjacent appraisals. 

filtered_sales %>%
  distinct() %>%
  group_by(owneryear) %>%
  summarize(sum_amount = sum(amount)) %>%
  ggplot(aes(x=owneryear, y=sum_amount))+
  geom_col()+
  ggtitle('Total Sales by Owner Year')+
  theme(axis.text.x = element_text(angle = 45, hjust=1))+
  xlab('Owner Year')+
  scale_y_continuous(name = 'Total Amount in USD (billions)', labels = unit_format(scale = 1e-9, unit = ''))

filtered_sales %>%
  distinct() %>%
  group_by(owneryear) %>%
  summarize(max_amount = max(amount)) %>%
  ggplot(aes(x=owneryear, y=max_amount))+
  geom_col(fill='red')+
  ggtitle('Max Sales by Owner Year')+
  theme(axis.text.x = element_text(angle = 45, hjust=1))+
  xlab('Owner Year')+
  scale_y_continuous(name = 'Max Sales USD (millions)', labels = unit_format(scale = 1e-6, unit = ''))

filtered_sales %>%
  distinct() %>%
  group_by(owneryear) %>%
  summarize(median_amount = median(amount)) %>%
  ggplot(aes(x=owneryear, y=median_amount))+
  geom_col(fill='blue')+
  ggtitle('Median Sales by Owner Year')+
  theme(axis.text.x = element_text(angle = 45, hjust=1))+
  xlab('Owner Year')+
  scale_y_continuous(name = 'Median Sales USD (millions)', labels = unit_format(scale = 1e-5, unit = ''))

filtered_sales %>%
  distinct() %>%
  group_by(owneryear) %>%
  summarize(count_apn = n_distinct(apn)) %>%
  ggplot(aes(x=owneryear, y=count_apn))+
  geom_col(fill='pink')+
  ggtitle('Historical Unique Property Count by Owner Year')+
  theme(axis.text.x = element_text(angle = 45, hjust=1))+
  xlab('Owner Year')+
  scale_y_continuous(name = 'Count of Unique Property (in 1000s)', labels = unit_format(scale = 1e-3, unit = ''))


```



```{r}
# 1. Using the sf library, find the closest development to each home. Hint: You can convert a tibble to an sf (simple feature) object using the [`st_as_sf` function](https://r-spatial.github.io/sf/reference/st_as_sf.html). See, for example, this stackoverflow post: https://gis.stackexchange.com/questions/222978/lon-lat-to-simple-features-sfg-and-sfc-in-r. Once converted, you can use the [`get_nearest_feature` function](https://r-spatial.github.io/sf/reference/st_nearest_feature.html).

library(stringr)
property_details[c('Longitude', 'Latitude')] <- str_split_fixed(property_details$centroid, ',', 2)
property_details$Longitude <- str_sub(property_details$Longitude, 2, -1)
property_details$Latitude <- str_sub(property_details$Latitude, 1, -2)

library(sf)

#Generate 'geometry' column in LIHTC and property_details
LIHTC <- st_as_sf(LIHTC, coords = c("LONGITUDE", "LATITUDE"), 
                 crs = 4326, agr = "constant")

property_details <- st_as_sf(property_details, coords = c("Longitude", "Latitude"), 
                 crs = 4326, agr = "constant")

try(st_nearest_feature(LIHTC, property_details))
```

```{r}
#2. Calculate the distance from each home its closest development.
```

```{r}
#3. Filter the homes down to those that are within one mile of an affordable housing development.

```




